#include <Arduino.h>
#include "wifi_module.h"
#include "api_module.h"
#include "dht_module.h"
#include "ds18b20_module.h"
#include "json_builder.h"
#include "scheduler.h"

// C·∫•u h√¨nh WiFi v√† API
const char* ssid = "Wokwi-GUEST";
const char* password = "";
const char* apiUrl = "https://my.duocnv.top/v1/hydroponics/snapshots";
const char* deviceToken = "esp32";
const char\* deviceId = "device-001";

// Modules
WifiModule wifi(ssid, password);
ApiModule api(apiUrl, deviceToken, deviceId);
DHTModule dht;
DS18B20Module ds18b20;

// B·ªô ƒë·ªám JSON
static char jsonBuf[256];

// G·ª≠i m·ªói 30 gi√¢y
const unsigned long SEND_INTERVAL_MS = 30000;
Scheduler scheduler(SEND_INTERVAL_MS);

// L·∫ßn ƒë·∫ßu setup
void setup() {
Serial.begin(115200);
delay(500);

wifi.connect(); // K·∫øt n·ªëi WiFi
dht.begin(); // Kh·ªüi ƒë·ªông DHT
ds18b20.begin(); // Kh·ªüi ƒë·ªông DS18B20
ds18b20.setResolution(12); // ƒêo nhanh (~94ms)

api.begin(); // Chu·∫©n b·ªã API client
}

// V√≤ng l·∫∑p ch√≠nh
void loop() {
// Ki·ªÉm tra th·ªùi gian g·ª≠i
if (!scheduler.ready()) return;

// T·ª± ƒë·ªông reconnect WiFi n·∫øu r·ªõt
if (WiFi.status() != WL_CONNECTED) {
Serial.println("‚ö† WiFi m·∫•t k·∫øt n·ªëi, th·ª≠ k·∫øt n·ªëi l·∫°i...");
wifi.connect();
delay(2000);
if (WiFi.status() != WL_CONNECTED) {
Serial.println("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi WiFi. B·ªè qua v√≤ng l·∫∑p.");
return;
}
}

// ƒê·ªçc c·∫£m bi·∫øn
float ambientTemp = dht.getTemperature();
float humidity = dht.getHumidity();

// L·∫•y nhi·ªát ƒë·ªô n∆∞·ªõc t·ª´ DS18B20 tr·ª±c ti·∫øp (wrapper t·ª± handle request)
float waterTemp = ds18b20.getTemperature();

// Debug print c√°c gi√° tr·ªã c·∫£m bi·∫øn
Serial.printf("üå° Ambient Temp: %.2f ¬∞C\n", ambientTemp);
Serial.printf("üíß Humidity: %.2f %%\n", humidity);
Serial.printf("üíß Water Temp: %.2f ¬∞C\n", waterTemp);

// Th√™m gi√° tr·ªã m√¥ ph·ªèng (c√≥ th·ªÉ thay b·∫±ng sensor th·ª±c)
float ph = 6.50, ec = 1.20;
int orp = 250;

// T·∫°o JSON
unsigned long t0 = millis();
size_t len = buildJsonSnapshots(jsonBuf, sizeof(jsonBuf),
waterTemp, ambientTemp,
humidity, ph, ec, orp);
unsigned long t1 = millis();
Serial.printf("üõ† Build JSON m·∫•t %lums\n", t1 - t0);

// G·ª≠i d·ªØ li·ªáu - th·ª≠ t·ªëi ƒëa 2 l·∫ßn n·∫øu l·∫ßn ƒë·∫ßu l·ªói
bool success = false;
unsigned long t2 = millis();
for (int attempt = 1; attempt <= 2 && !success; ++attempt) {
Serial.printf("üì° ƒêang g·ª≠i d·ªØ li·ªáu (l·∫ßn %d)...\n", attempt);
success = api.sendData(jsonBuf, len);
if (!success) delay(500);
}
unsigned long t3 = millis();
Serial.printf("üì§ G·ª≠i m·∫•t %lums\n", t3 - t2);

// K·∫øt qu·∫£
if (success) {
Serial.println("‚úÖ G·ª≠i d·ªØ li·ªáu th√†nh c√¥ng!");
} else {
Serial.println("‚ùå G·ª≠i th·∫•t b·∫°i ho√†n to√†n.");
}

// ƒê√≥ng k·∫øt n·ªëi HTTP sau m·ªói l·∫ßn g·ª≠i (b·∫•t k·ªÉ th√†nh c√¥ng hay th·∫•t b·∫°i)
api.endConnection();
}
